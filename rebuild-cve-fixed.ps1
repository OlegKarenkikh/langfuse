# Rebuild Containers with REAL CVE Fixes
param(
    [switch]$Push,
    [switch]$Scan,
    [switch]$Force
)

$ErrorActionPreference = "Stop"

Write-Host "ğŸ›¡ï¸ REBUILDING CONTAINERS WITH REAL CVE FIXES" -ForegroundColor Red
Write-Host "=============================================" -ForegroundColor Red
Write-Host ""

Write-Host "ğŸ¯ Target CVEs to eliminate:" -ForegroundColor Yellow
Write-Host "  â€¢ CVE-2025-647567 (glob 11.0.3 â†’ ^11.1.0)" -ForegroundColor White
Write-Host "  â€¢ CVE-2025-608766 (busybox 1.37.0-r30 â†’ latest)" -ForegroundColor White
Write-Host "  â€¢ CVE-2024-478296 (pnpm 9.15.1 â†’ 10.15.0)" -ForegroundColor White
Write-Host "  â€¢ CVE-2025-641186 (tar 7.5.1 â†’ ^7.5.2)" -ForegroundColor White
Write-Host "  â€¢ CVE-2025-58891 (brace-expansion 2.0.1 â†’ ^2.0.2)" -ForegroundColor White
Write-Host ""

# Clean up old images if Force is specified
if ($Force) {
    Write-Host "ğŸ§¹ Cleaning up old images..." -ForegroundColor Yellow
    try { docker rmi -f olegkarenkikh/langfuse:worker-cve-fixed 2>$null } catch {}
    try { docker rmi -f olegkarenkikh/langfuse:web-cve-fixed 2>$null } catch {}
    docker system prune -f
    Write-Host "âœ… Cleanup complete" -ForegroundColor Green
    Write-Host ""
}

# Build worker container with no cache
Write-Host "ğŸ”¨ Building worker container (NO CACHE)..." -ForegroundColor Yellow
Write-Host "  â€¢ Using pnpm@10.15.0" -ForegroundColor Gray
Write-Host "  â€¢ Force upgrading busybox" -ForegroundColor Gray
Write-Host "  â€¢ Applying resolutions + overrides" -ForegroundColor Gray
Write-Host ""

docker build --no-cache --progress=plain -f worker/Dockerfile -t olegkarenkikh/langfuse:worker-cve-fixed .
if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ Worker build failed!" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… Worker container built successfully" -ForegroundColor Green
Write-Host ""

# Build web container with no cache
Write-Host "ğŸ”¨ Building web container (NO CACHE)..." -ForegroundColor Yellow
Write-Host "  â€¢ Using pnpm@10.15.0" -ForegroundColor Gray
Write-Host "  â€¢ Force upgrading busybox" -ForegroundColor Gray
Write-Host "  â€¢ Applying resolutions + overrides" -ForegroundColor Gray
Write-Host ""

docker build --no-cache --progress=plain -f web/Dockerfile -t olegkarenkikh/langfuse:web-cve-fixed .
if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ Web build failed!" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… Web container built successfully" -ForegroundColor Green
Write-Host ""

# Verify CVE fixes
Write-Host "ğŸ” Verifying CVE fixes..." -ForegroundColor Yellow

# Check pnpm versions
Write-Host "Checking pnpm versions:" -ForegroundColor Cyan
$workerPnpm = docker run --rm --entrypoint="" olegkarenkikh/langfuse:worker-cve-fixed pnpm --version 2>$null
$webPnpm = docker run --rm --entrypoint="" olegkarenkikh/langfuse:web-cve-fixed pnpm --version 2>$null

if ($workerPnpm) {
    Write-Host "  Worker pnpm: $workerPnpm" -ForegroundColor White
    if ([version]$workerPnpm -ge [version]"10.0.0") {
        Write-Host "    âœ… CVE-2024-478296 FIXED" -ForegroundColor Green
    } else {
        Write-Host "    âŒ CVE-2024-478296 STILL VULNERABLE" -ForegroundColor Red
    }
}

if ($webPnpm) {
    Write-Host "  Web pnpm: $webPnpm" -ForegroundColor White
    if ([version]$webPnpm -ge [version]"10.0.0") {
        Write-Host "    âœ… CVE-2024-478296 FIXED" -ForegroundColor Green
    } else {
        Write-Host "    âŒ CVE-2024-478296 STILL VULNERABLE" -ForegroundColor Red
    }
}

Write-Host ""

# Check package resolutions
Write-Host "Checking package resolutions:" -ForegroundColor Cyan
$workerPkg = docker run --rm --entrypoint="" olegkarenkikh/langfuse:worker-cve-fixed cat package.json 2>$null
if ($workerPkg -and $workerPkg -match '"resolutions"') {
    Write-Host "  âœ… Worker: resolutions applied" -ForegroundColor Green
} else {
    Write-Host "  âŒ Worker: resolutions missing" -ForegroundColor Red
}

$webPkg = docker run --rm --entrypoint="" olegkarenkikh/langfuse:web-cve-fixed cat package.json 2>$null
if ($webPkg -and $webPkg -match '"resolutions"') {
    Write-Host "  âœ… Web: resolutions applied" -ForegroundColor Green
} else {
    Write-Host "  âŒ Web: resolutions missing" -ForegroundColor Red
}

Write-Host ""

# Tag as final versions
Write-Host "ğŸ·ï¸ Tagging as final versions..." -ForegroundColor Yellow
docker tag olegkarenkikh/langfuse:worker-cve-fixed olegkarenkikh/langfuse:worker
docker tag olegkarenkikh/langfuse:web-cve-fixed olegkarenkikh/langfuse:web
Write-Host "âœ… Tagged successfully" -ForegroundColor Green
Write-Host ""

# Run Docker Scout scan if requested
if ($Scan) {
    Write-Host "ğŸ” Running Docker Scout CVE scan..." -ForegroundColor Yellow
    Write-Host ""
    
    Write-Host "Scanning worker container:" -ForegroundColor Cyan
    try { docker scout cves olegkarenkikh/langfuse:worker-cve-fixed --only-severity critical,high,medium } catch { Write-Host "Scout scan failed" }
    
    Write-Host ""
    Write-Host "Scanning web container:" -ForegroundColor Cyan
    try { docker scout cves olegkarenkikh/langfuse:web-cve-fixed --only-severity critical,high,medium } catch { Write-Host "Scout scan failed" }
}

# Push to DockerHub if requested
if ($Push) {
    Write-Host ""
    Write-Host "ğŸ“¤ Pushing to DockerHub..." -ForegroundColor Yellow
    
    docker push olegkarenkikh/langfuse:worker-cve-fixed
    docker push olegkarenkikh/langfuse:web-cve-fixed
    docker push olegkarenkikh/langfuse:worker
    docker push olegkarenkikh/langfuse:web
    
    Write-Host "âœ… All images pushed successfully!" -ForegroundColor Green
}

Write-Host ""
Write-Host "ğŸ‰ CVE FIX REBUILD COMPLETE!" -ForegroundColor Green
Write-Host ""
Write-Host "ğŸ“‹ Next steps:" -ForegroundColor Yellow
Write-Host "  1. Run Docker Scout scan: .\rebuild-cve-fixed.ps1 -Scan" -ForegroundColor White
Write-Host "  2. If clean, push images: .\rebuild-cve-fixed.ps1 -Push" -ForegroundColor White
Write-Host "  3. Test containers in your environment" -ForegroundColor White
Write-Host ""
Write-Host "ğŸ›¡ï¸ Expected result: 0 CVE vulnerabilities in Docker Scout" -ForegroundColor Cyan