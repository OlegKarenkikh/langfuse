# Simple CVE Check for AlmaLinux Container
param([string]$ContainerName = "olegkarenkikh/langfuse:worker-almalinux-hybrid")

Write-Host "Checking CVE status for: $ContainerName" -ForegroundColor Cyan

# Check if container exists
$exists = docker images --format "{{.Repository}}:{{.Tag}}" | Select-String "^$ContainerName$"
if (-not $exists) {
    Write-Host "Container $ContainerName not found locally" -ForegroundColor Red
    exit 1
}

Write-Host "`nChecking pnpm version (CVE-2024-478296)..." -ForegroundColor Yellow
$pnpmVersion = docker run --rm $ContainerName pnpm --version 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "pnpm version: $pnpmVersion" -ForegroundColor White
    if ([version]$pnpmVersion -ge [version]"9.16.0") {
        Write-Host "✅ CVE-2024-478296 FIXED (pnpm >= 9.16.0)" -ForegroundColor Green
    } else {
        Write-Host "❌ CVE-2024-478296 VULNERABLE (pnpm $pnpmVersion < 9.16.0)" -ForegroundColor Red
    }
} else {
    Write-Host "Could not check pnpm version" -ForegroundColor Yellow
}

Write-Host "`nChecking Node.js version..." -ForegroundColor Yellow
$nodeVersion = docker run --rm $ContainerName node --version 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "Node.js version: $nodeVersion" -ForegroundColor White
}

Write-Host "`nChecking OS base..." -ForegroundColor Yellow
$osInfo = docker run --rm $ContainerName cat /etc/os-release 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "OS Info:" -ForegroundColor White
    Write-Host $osInfo
}

Write-Host "`nRunning Docker Scout scan..." -ForegroundColor Yellow
docker scout cves $ContainerName --format table --only-severity critical,high,medium 2>$null
if ($LASTEXITCODE -ne 0) {
    Write-Host "Docker Scout not available or container not found" -ForegroundColor Yellow
}

Write-Host "`nCVE Check Complete!" -ForegroundColor Green