# PowerShell script to verify CVE fixes are applied
param(
    [switch]$Docker = $false
)

Write-Host "üîç Checking CVE fixes..." -ForegroundColor Cyan
Write-Host "==========================" -ForegroundColor Cyan

try {
    # Check pnpm version
    Write-Host "üì¶ Checking pnpm version:" -ForegroundColor Yellow
    $pnpmVersion = pnpm --version
    Write-Host "pnpm: $pnpmVersion" -ForegroundColor Green
    
    if ($pnpmVersion -lt "9.15.0") {
        Write-Host "‚ö†Ô∏è  pnpm version is below 9.15.0 (CVE-2024-47829, CVE-2024-53866)" -ForegroundColor Red
    } else {
        Write-Host "‚úÖ pnpm version is up to date" -ForegroundColor Green
    }

    Write-Host ""
    Write-Host "üìã Checking npm package versions:" -ForegroundColor Yellow

    # Check package versions through overrides
    $packageJson = Get-Content "package.json" | ConvertFrom-Json
    
    # Check cross-spawn version (CVE-2024-21538)
    $crossSpawnVersion = $packageJson.pnpm.overrides."cross-spawn"
    Write-Host "cross-spawn override: $crossSpawnVersion" -ForegroundColor Green
    
    # Check glob version (CVE-2025-64756) 
    $globVersion = $packageJson.pnpm.overrides."glob"
    Write-Host "glob override: $globVersion" -ForegroundColor Green
    
    # Check tar version (CVE-2025-64118)
    $tarVersion = $packageJson.pnpm.overrides."tar"
    Write-Host "tar override: $tarVersion" -ForegroundColor Green
    
    # Check brace-expansion version (CVE-2025-5889)
    $braceExpansionVersion = $packageJson.pnpm.overrides."brace-expansion"
    Write-Host "brace-expansion override: $braceExpansionVersion" -ForegroundColor Green

    Write-Host ""
    Write-Host "üîí Running security audit:" -ForegroundColor Yellow
    try {
        pnpm audit --audit-level=moderate
        Write-Host "‚úÖ No moderate+ vulnerabilities found" -ForegroundColor Green
    } catch {
        Write-Host "‚ö†Ô∏è  Some vulnerabilities found - check if they are the ones we fixed" -ForegroundColor Yellow
    }

    if ($Docker) {
        Write-Host ""
        Write-Host "üê≥ Checking Docker image versions:" -ForegroundColor Yellow
        
        try {
            $dockerPnpmVersion = docker run --rm langfuse-langfuse-web:latest pnpm --version
            Write-Host "Docker pnpm version: $dockerPnpmVersion" -ForegroundColor Green
            
            $dockerBusyboxVersion = docker run --rm langfuse-langfuse-web:latest apk list busybox
            Write-Host "Docker busybox version: $dockerBusyboxVersion" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è  Could not check Docker image versions. Make sure the image is built." -ForegroundColor Yellow
        }
    }

    Write-Host ""
    Write-Host "‚úÖ CVE check completed!" -ForegroundColor Green
    
} catch {
    Write-Host "‚ùå Error during CVE check: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "üìù Manual Docker checks:" -ForegroundColor Cyan
Write-Host "   docker run --rm langfuse-langfuse-web:latest pnpm --version" -ForegroundColor Gray
Write-Host "   docker run --rm langfuse-langfuse-web:latest apk list busybox" -ForegroundColor Gray