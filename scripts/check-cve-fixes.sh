#!/bin/bash

# Script to verify CVE fixes are applied
set -e

echo "ğŸ” Checking CVE fixes..."
echo "=========================="

# Check pnpm version
echo "ğŸ“¦ Checking pnpm version:"
pnpm --version

# Check package versions in lockfile
echo ""
echo "ğŸ“‹ Checking npm package versions:"

# Check cross-spawn version (CVE-2024-21538)
echo -n "cross-spawn: "
pnpm list cross-spawn --depth=0 2>/dev/null | grep cross-spawn || echo "Not found in direct dependencies"

# Check glob version (CVE-2025-64756) 
echo -n "glob: "
pnpm list glob --depth=0 2>/dev/null | grep glob || echo "Not found in direct dependencies"

# Check tar version (CVE-2025-64118)
echo -n "tar: "
pnpm list tar --depth=0 2>/dev/null | grep tar || echo "Not found in direct dependencies"

# Check brace-expansion version (CVE-2025-5889)
echo -n "brace-expansion: "
pnpm list brace-expansion --depth=0 2>/dev/null | grep brace-expansion || echo "Not found in direct dependencies"

echo ""
echo "ğŸ”’ Running security audit:"
pnpm audit --audit-level=moderate || echo "âš ï¸  Some vulnerabilities found - check if they are the ones we fixed"

echo ""
echo "âœ… CVE check completed!"
echo ""
echo "ğŸ“ To check Docker image versions:"
echo "   docker run --rm langfuse-langfuse-web:latest pnpm --version"
echo "   docker run --rm langfuse-langfuse-web:latest apk list busybox"