# Aggressive CVE Fix Script
Write-Host "üö® AGGRESSIVE CVE FIX APPROACH" -ForegroundColor Red
Write-Host "==============================" -ForegroundColor Red
Write-Host ""

Write-Host "This will try the most aggressive approach to fix CVE vulnerabilities:" -ForegroundColor Yellow
Write-Host "1. Update Alpine base image to 3.24" -ForegroundColor White
Write-Host "2. Force replace vulnerable packages after install" -ForegroundColor White
Write-Host "3. Use exact versions for security packages" -ForegroundColor White
Write-Host ""

# Create aggressive Dockerfile for worker
$aggressiveWorkerDockerfile = @"
# ============================================
# Aggressive CVE Fix - Worker Container
# ============================================
FROM --platform=`${TARGETPLATFORM:-linux/amd64} node:24-alpine3.24 AS alpine

# Force update ALL Alpine packages and busybox
RUN apk update && \
    apk upgrade --no-cache && \
    apk add --no-cache --upgrade busybox && \
    apk add --no-cache \
    libcrypto3 \
    libssl3 \
    libc6-compat \
    ssl_client

# Rest of the Dockerfile remains the same...
# (Copy from existing worker/Dockerfile but with aggressive package replacement)

# After pnpm install, force replace vulnerable packages
RUN pnpm install --no-frozen-lockfile --force && \
    echo "Forcefully replacing vulnerable packages..." && \
    rm -rf node_modules/glob && \
    pnpm add glob@11.1.0 --save-exact --workspace-root && \
    rm -rf node_modules/tar && \
    pnpm add tar@7.5.2 --save-exact --workspace-root && \
    rm -rf node_modules/brace-expansion && \
    pnpm add brace-expansion@2.0.2 --save-exact --workspace-root && \
    rm -rf node_modules/cross-spawn && \
    pnpm add cross-spawn@7.0.6 --save-exact --workspace-root
"@

Write-Host "Aggressive approach created in concept." -ForegroundColor Green
Write-Host ""
Write-Host "‚ö†Ô∏è  WARNING: This approach is experimental and may break functionality!" -ForegroundColor Red
Write-Host ""
Write-Host "Recommended next steps:" -ForegroundColor Yellow
Write-Host "1. Try updating to Alpine 3.24 first" -ForegroundColor White
Write-Host "2. Test with exact package versions" -ForegroundColor White
Write-Host "3. Consider using Distroless base images" -ForegroundColor White
Write-Host "4. Implement automated CVE scanning in CI/CD" -ForegroundColor White
Write-Host ""
Write-Host "Current status: 5 CVE vulnerabilities remain unresolved" -ForegroundColor Red
Write-Host "Risk level: HIGH due to CVE-2025-64756 (CVSS 7.5)" -ForegroundColor Red