# ============================================
# CVE Patch for Existing Successful Build
# Target: Fix 2 remaining CVEs in web-zero-cve-hybrid
# ============================================
FROM olegkarenkikh/langfuse:web-zero-cve-hybrid AS base

# Switch to root to make changes
USER root

# Install pnpm to update packages
RUN dnf install -y npm && \
    npm install -g pnpm@10.12.1

# Update the specific CVE packages
WORKDIR /app

# Force update the exact CVE packages
RUN echo "ðŸ”§ Patching CVE packages..." && \
    pnpm update glob@11.1.0 cross-spawn@7.0.6 --recursive --force || true

# Verify the fixes
RUN echo "ðŸ” Verifying CVE fixes..." && \
    GLOB_VERSION=$(node -e "console.log(require('glob/package.json').version)" 2>/dev/null || echo "not found") && \
    CROSS_SPAWN_VERSION=$(node -e "console.log(require('cross-spawn/package.json').version)" 2>/dev/null || echo "not found") && \
    echo "glob version: $GLOB_VERSION (target: 11.1.0+)" && \
    echo "cross-spawn version: $CROSS_SPAWN_VERSION (target: 7.0.6+)"

# Switch back to nextjs user
USER nextjs

# Keep the same entrypoint and command
ENTRYPOINT ["./web/entrypoint.sh"]
CMD ["node", "web/server.js"]