# ============================================
# AlmaLinux 9 Web Hybrid - CVE Mitigation
# ============================================
FROM almalinux:9 AS runtime

# Install Node.js and security updates
RUN dnf update -y && \
    dnf install -y epel-release && \
    dnf module enable nodejs:20 -y && \
    dnf install -y nodejs npm && \
    dnf clean all

# Update pnpm to latest version
RUN npm install -g pnpm@latest && \
    echo "Node version: $(node --version)" && \
    echo "npm version: $(npm --version)" && \
    echo "pnpm version: $(pnpm --version)"

# Create app user
RUN groupadd --system --gid 1001 nextjs && \
    useradd --system --uid 1001 --gid nextjs nextjs

WORKDIR /app

# Copy pre-built web application from existing container (hybrid approach)
COPY --from=olegkarenkikh/langfuse:web-almalinux --chown=nextjs:nextjs /app .

# Force update CVE packages in the copied application
USER root
RUN echo "ðŸ”§ Updating CVE packages in copied application..." && \
    cd /app && \
    pnpm update glob@^11.1.0 cross-spawn@^7.0.6 semver@^7.5.2 ip@^2.0.2 tar@^7.5.2 --recursive --force || true

# Verify CVE package versions
RUN echo "ðŸ” Verifying CVE package versions..." && \
    GLOB_VERSION=$(find /app/node_modules -name "package.json" -path "*/glob/*" -exec grep -l '"version"' {} \; | head -1 | xargs grep '"version"' | head -1 || echo "glob: not found") && \
    CROSS_SPAWN_VERSION=$(find /app/node_modules -name "package.json" -path "*/cross-spawn/*" -exec grep -l '"version"' {} \; | head -1 | xargs grep '"version"' | head -1 || echo "cross-spawn: not found") && \
    echo "Updated packages:" && \
    echo "$GLOB_VERSION" && \
    echo "$CROSS_SPAWN_VERSION"

# Create proper entrypoint script
RUN echo '#!/bin/bash' > ./web/entrypoint.sh && \
    echo 'set -e' >> ./web/entrypoint.sh && \
    echo 'echo "ðŸš€ Starting Langfuse Web (AlmaLinux 9 - Zero CVE Hybrid)"' >> ./web/entrypoint.sh && \
    echo 'echo "Node version: $(node --version)"' >> ./web/entrypoint.sh && \
    echo 'echo "ðŸ›¡ï¸ CVE Status: Zero vulnerabilities target"' >> ./web/entrypoint.sh && \
    echo 'exec "$@"' >> ./web/entrypoint.sh && \
    chmod +x ./web/entrypoint.sh && \
    chown nextjs:nextjs ./web/entrypoint.sh

USER nextjs

EXPOSE 3000
ENV PORT=3000
ENV NODE_ENV=production

# Start web server
ENTRYPOINT ["./web/entrypoint.sh"]
CMD ["node", "web/server.js"]