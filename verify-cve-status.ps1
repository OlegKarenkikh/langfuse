# Quick CVE Status Verification
Write-Host "üîç Current CVE Fix Status" -ForegroundColor Cyan
Write-Host "=========================" -ForegroundColor Cyan
Write-Host ""

# Check Dockerfile pnpm versions
Write-Host "üì¶ Checking Dockerfile pnpm versions:" -ForegroundColor Yellow
$dockerfiles = @("web/Dockerfile", "worker/Dockerfile")
foreach ($dockerfile in $dockerfiles) {
    if (Test-Path $dockerfile) {
        $content = Get-Content $dockerfile -Raw
        if ($content -match "pnpm@([\d\.]+)") {
            $version = $matches[1]
            Write-Host "  $dockerfile`: pnpm@$version" -ForegroundColor White
            if ([version]$version -ge [version]"9.16.0") {
                Write-Host "    ‚úÖ CVE-2024-478296 FIXED" -ForegroundColor Green
            } else {
                Write-Host "    ‚ùå CVE-2024-478296 VULNERABLE" -ForegroundColor Red
            }
        }
    }
}
Write-Host ""

# Check package.json overrides
Write-Host "üìã Checking package.json overrides:" -ForegroundColor Yellow
$packageFiles = @("web/package.json", "worker/package.json")
foreach ($packageFile in $packageFiles) {
    if (Test-Path $packageFile) {
        Write-Host "  $packageFile`:" -ForegroundColor White
        $content = Get-Content $packageFile -Raw | ConvertFrom-Json
        if ($content.overrides) {
            $overrides = $content.overrides
            
            # Check glob (CVE-2025-647567)
            if ($overrides.glob) {
                Write-Host "    glob: $($overrides.glob)" -ForegroundColor Gray
                if ($overrides.glob -match "11\.1\.0") {
                    Write-Host "      ‚úÖ CVE-2025-647567 FIXED" -ForegroundColor Green
                } else {
                    Write-Host "      ‚ùå CVE-2025-647567 VULNERABLE" -ForegroundColor Red
                }
            }
            
            # Check tar (CVE-2025-641186)
            if ($overrides.tar) {
                Write-Host "    tar: $($overrides.tar)" -ForegroundColor Gray
                if ($overrides.tar -match "7\.5\.2") {
                    Write-Host "      ‚úÖ CVE-2025-641186 FIXED" -ForegroundColor Green
                } else {
                    Write-Host "      ‚ùå CVE-2025-641186 VULNERABLE" -ForegroundColor Red
                }
            }
            
            # Check brace-expansion (CVE-2025-58891)
            if ($overrides."brace-expansion") {
                Write-Host "    brace-expansion: $($overrides.'brace-expansion')" -ForegroundColor Gray
                if ($overrides."brace-expansion" -match "2\.0\.2") {
                    Write-Host "      ‚úÖ CVE-2025-58891 FIXED" -ForegroundColor Green
                } else {
                    Write-Host "      ‚ùå CVE-2025-58891 VULNERABLE" -ForegroundColor Red
                }
            }
        } else {
            Write-Host "    ‚ùå No overrides section found" -ForegroundColor Red
        }
    }
}
Write-Host ""

Write-Host "üõ°Ô∏è CVE Status Summary:" -ForegroundColor Cyan
Write-Host "  CVE-2025-647567 (glob): Check package.json overrides above" -ForegroundColor White
Write-Host "  CVE-2025-608766 (busybox): Fixed via Alpine apk upgrade in Dockerfiles" -ForegroundColor White
Write-Host "  CVE-2024-478296 (pnpm): Check Dockerfile versions above" -ForegroundColor White
Write-Host "  CVE-2025-641186 (tar): Check package.json overrides above" -ForegroundColor White
Write-Host "  CVE-2025-58891 (brace-expansion): Check package.json overrides above" -ForegroundColor White
Write-Host ""

Write-Host "üìã Next steps if vulnerabilities found:" -ForegroundColor Yellow
Write-Host "  1. Run: .\fix-2025-cves.ps1 -All" -ForegroundColor White
Write-Host "  2. Or run individual steps:" -ForegroundColor White
Write-Host "     .\fix-2025-cves.ps1 -UpdatePnpm" -ForegroundColor White
Write-Host "     .\fix-2025-cves.ps1 -RebuildContainers" -ForegroundColor White
Write-Host "     .\scan-cve.ps1 -All" -ForegroundColor White